<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°—è±¡æƒ…å ±ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
<style>
body {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  margin: 5px;
  background: #fff;
  font-size: 14px;
  line-height: 1.4;
}

#weather {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  white-space: pre-wrap;
  margin: 0;
  padding: 5px;
}

#statusBar {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 2px;
}

#status {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  font-size: 12px;
}

#controls {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  margin-bottom: 2px;
}

#regionSelect,
#copyBtn,
#helpBtn,
#shareBtn,
#closeHelpBtn {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  font-size: 12px;
  padding: 2px 5px;
  cursor: pointer;
}

/* ===== ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
#helpOverlay {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;              /* â† åˆæœŸã¯å¿…ãšéè¡¨ç¤º */
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#helpModal {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  background: #fff;
  padding: 12px;
  max-width: 400px;
  width: 90%;
  font-size: 13px;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#helpModal h3 {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  margin-top: 0;
  font-size: 14px;
}
</style>
</head>
<body>

<div id="statusBar">
  <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button id="helpBtn">ãƒ˜ãƒ«ãƒ—</button>
</div>

<div id="controls">
  <select id="regionSelect"></select>
  <!--
    <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
  -->
  <button id="shareBtn">å…±æœ‰</button>
</div>

<div id="helpOverlay">
  <div id="helpModal">
    <h3>æ°—è±¡æƒ…å ±ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h3>

    <p>
      ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€æ°—è±¡æƒ…å ±ï¼ˆå…¨èˆ¬æ°—è±¡æƒ…å ±ã€åœ°æ–¹æ°—è±¡æƒ…å ±ã€åºœçœŒæ°—è±¡æƒ…å ±ï¼‰ã‚’é–²è¦§ã§ãã¾ã™ã€‚<br><br>

      ï¼œç‰¹å¾´ï¼<br>
      ãƒ»æœ€å¾Œã«è¦‹ãŸåœ°åŸŸã®é–²è¦§ãƒ‡ãƒ¼ã‚¿ã‚’æ®‹ã—ã€æ¬¡å›ä»¥é™ã™ãã«é–²è¦§å¯èƒ½ã§ã™ã€‚<br>
      ã€€â€»å€‹äººæƒ…å ±ã®åé›†ç­‰ã¯ä¸€åˆ‡è¡Œã£ã¦ã„ã¾ã›ã‚“<br>
      ãƒ»è¡¨ç¤ºå†…å®¹ã®è»¢é€ãŒå¯èƒ½ãªãŸã‚ã€å®¶æ—ã‚„å‹äººãªã©ã«ã™ãã«å…±æœ‰ã§ãã¾ã™ã€‚<br><br>

      ï¼œæ³¨æ„ç‚¹ï¼<br>
      ãƒ»GoogleAppsScriptã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€æ¥ç¶šãŒä¸å®‰å®šã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
      ãƒ»ä¸å…·åˆåŠã³ä¸æ˜ãªç‚¹ãŒã‚ã‚‹å ´åˆã¯ã€ä½œæˆè€…ï¼ˆãªãµãƒãƒ¼ï¼‰ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚<br><br>

      æƒ…å ±å…ƒã€€æ°—è±¡åºXML<br>
      æ•´ã€€å½¢ã€€ãªãµãƒãƒ¼
      
    </p>

    <button id="closeHelpBtn" type="button">é–‰ã˜ã‚‹</button>
  </div>
</div>

<pre id="weather">èª­ã¿è¾¼ã¿ä¸­...<br><br>èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</pre>

<script>
const outputEl = document.getElementById("weather");
const statusEl = document.getElementById("status");
const copyBtn = document.getElementById("copyBtn");
const regionSelect = document.getElementById("regionSelect");

let latestData = null;

function isValid(value) {
  return value !== undefined &&
         value !== null &&
         !(typeof value === "number" && isNaN(value)) &&
         value !== "";
}

function formatReportTime(dateStr) {
  const d = new Date(dateStr);
  const month = String(d.getMonth() + 1).padStart(2, '0'); // â† æœˆï¼ˆ+1å¿…é ˆï¼‰
  const dd = String(d.getDate()).padStart(2, '0');
  const HH = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  return `${month}æœˆ${dd}æ—¥${HH}:${mm}ã€€æ°—è±¡åºç™ºè¡¨`;
}

function renderRegion(region) {
  const info = latestData[region];

  // â‘  regionè‡ªä½“ãŒå­˜åœ¨ã—ãªã„ï¼ˆå–å¾—å¤±æ•—ãƒ»JSONä¸æ­£ãªã©ï¼‰
  if (!info) {
    outputEl.textContent =
      `ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:ã€${region}ã€‘ã®æ°—è±¡æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`;
    return;
  }

  // â‘¡ ã‚»ãƒ«ãŒç©ºï¼ˆå–å¾—ã¯æˆåŠŸã—ã¦ã„ã‚‹ãŒæœªç™ºè¡¨ï¼‰
  if (
    !isValid(info.title) &&
    !isValid(info.headLineText) &&
    !isValid(info.bodyText)
  ) {
    outputEl.textContent =
      `æ°—è±¡æƒ…å ±åé›†ä¸­ï¼šã€${region}ã€‘ã®æ°—è±¡æƒ…å ±ã‚’åé›†ä¸­ã§ã™ã€‚æ°—è±¡åºã«ã‚ˆã‚Šæƒ…å ±ãŒç™ºè¡¨ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚`;
    return;
  }

  // â‘¢ æ­£å¸¸è¡¨ç¤º
  outputEl.textContent =
    `ğŸŸ©${info.title}ğŸŸ©\n` +
    `${formatReportTime(info.report)}\n\n` +
    `${info.headLineText}\n\n` +
    `${info.bodyText}\n\n` +
    `å‡ºå…¸ï¼šæ°—è±¡åºXML\nformatted by NAFY`;
}

async function updateWeather() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbySQgagfqixnbX1Tvgi4K28yM4v2XUdtR3BBn1kb-1wQS0hAKUz28IJaUqGeIY04-0LRw/exec");
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    latestData = data;

    regionSelect.innerHTML = "";

    for (const region of Object.keys(data)) {
      if (region === "title" || region === "update") continue;

      const info = data[region];
      if (!info?.type) continue;

      let label =
        info.type === "General" ? "[å…¨èˆ¬] å…¨èˆ¬æ°—è±¡æƒ…å ±" :
        info.type === "Local"   ? `[åœ°æ–¹] ${region}` :
        info.type === "Pref"    ? `[åºœçœŒ] ${region}` :
        region;

      const opt = document.createElement("option");
      opt.value = region;
      opt.textContent = label;
      regionSelect.appendChild(opt);
    }

    const savedRegion = localStorage.getItem("selectedRegion");
    const regionToShow =
      savedRegion && latestData[savedRegion]
        ? savedRegion
        : regionSelect.options[0]?.value;

    if (regionToShow) {
      regionSelect.value = regionToShow;
      renderRegion(regionToShow);
    }

    const d = new Date(data.update);
    statusEl.textContent =
      `æœ€çµ‚æ›´æ–°: ${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ` +
      `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;

  } catch(e) {
    outputEl.textContent =
      "å–å¾—ã‚¨ãƒ©ãƒ¼: " + e.message +
      "\n\nâ—†å†èª­ã¿è¾¼ã¿ã™ã‚‹ã‹ã€ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚â—†";
    statusEl.textContent = "æ›´æ–°å¤±æ•—";
  }
}

regionSelect.addEventListener("change", () => {
  localStorage.setItem("selectedRegion", regionSelect.value);
  renderRegion(regionSelect.value);
});

if (copyBtn) {
  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(outputEl.textContent).then(() => {
      const t = copyBtn.textContent;
      copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
      setTimeout(() => copyBtn.textContent = t, 1500);
    });
  });
}

/* ===== ãƒ˜ãƒ«ãƒ—åˆ¶å¾¡ ===== */
const helpBtn = document.getElementById("helpBtn");
const helpOverlay = document.getElementById("helpOverlay");
const closeHelpBtn = document.getElementById("closeHelpBtn");

helpBtn.addEventListener("click", () => {
  helpOverlay.style.display = "flex";
});

closeHelpBtn.addEventListener("click", (e) => {
  e.stopPropagation();          // â† é‡è¦
  helpOverlay.style.display = "none";
});

helpOverlay.addEventListener("click", (e) => {
  if (e.target === helpOverlay) {
    helpOverlay.style.display = "none";
  }
});

const shareBtn = document.getElementById("shareBtn");

shareBtn.addEventListener("click", async () => {
  const text = outputEl.textContent;

  if (!text) return;

  // Web Share API å¯¾å¿œç’°å¢ƒï¼ˆã‚¹ãƒãƒ›ãƒ»ä¸€éƒ¨PCï¼‰
  if (navigator.share) {
    try {
      await navigator.share({
        title: "æ°—è±¡æƒ…å ±",
        text: text
      });
    } catch (e) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ãªã©ã¯ä½•ã‚‚ã—ãªã„
    }
  } else {
    // éå¯¾å¿œç’°å¢ƒ â†’ ã‚³ãƒ”ãƒ¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    navigator.clipboard.writeText(text).then(() => {
      alert("å…±æœ‰æ©Ÿèƒ½ãŒæœªå¯¾å¿œã®ãŸã‚ã€æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    });
  }
});

updateWeather();
</script>

</body>
</html>
